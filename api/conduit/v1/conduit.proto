syntax = "proto3";

package realworld.v1;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";

option go_package = "kratos-realworld/api/conduit/v1;v1";

// The greeting service definition.
service Conduit {
  rpc Register(RegisterRequest) returns (RegisterReply) {
    option (google.api.http) = {
      post : "/api/users",
      body : "*",
    };
  }

  rpc Login(LoginRequest) returns (LoginReply) {
    option (google.api.http) = {
      post : "/api/users/login",
      body : "*",
    };
  }

  rpc LoginBySms(LoginBySmsRequest) returns (LoginReply) {
    option (google.api.http) = {
      post : "/api/users/login/sms",
      body : "*",
    };
  }

  rpc SendSms(SendSmsRequest) returns (SendSmsReply) {
    option (google.api.http) = {
      post : "/api/users/sendSms",
      body : "*",
    };
  }

  rpc UpdateUserPassword(UpdateUserPwdRequest) returns (UpdateUserPwdReply) {
    option (google.api.http) = {
      post : "/api/users/updatePassword",
      body : "*",
    };
  }

  rpc ResetUserPassword(ResetUserPwdRequest) returns (ResetUserPwdReply) {
    option (google.api.http) = {
      post : "/api/users/resetPassword",
      body : "*",
    };
  }

  rpc UpdateUserInfo(UpdateUserInfoRequest) returns (UpdateUserInfoReply) {
    option (google.api.http) = {
      put  : "/api/users/updateUserInfo",
      body : "*"
    };
  }

  rpc GetProfile(GetProfileRequest) returns (GetProfileReply) {
    option (google.api.http) = {
      get : "/api/profiles/{user_id}",
    };
  }

  rpc FollowUser(FollowUserRequest) returns (FollowFanReply) {
    option (google.api.http) = {
      post : "/api/profiles/{target_id}/follow",
      body : "*",
    };
  }

  rpc UnfollowUser(UnfollowUserRequest) returns (FollowFanReply) {
    option (google.api.http) = {
      post : "/api/profiles/{target_id}/unfollow",
      body : "*",
    };
  }

  rpc GetRelationship(RelationshipRequest) returns (RelationshipReply) {
    option (google.api.http) = {
      get : "/api/profiles/{target_id}/relationship",
    };
  }

  rpc CanAddFriend(CanAddFriendReq) returns (CanAddFriendRes) {
    option (google.api.http) = {
      post : "/api/profiles/{target_id}/canAddFriend",
      body : "*",
    };
  }

  rpc GetMessages(GetMessagesRequest) returns (GetMessagesReply) {
    option (google.api.http) = {
      get : "/api/chat",
    };
  }


  rpc GetMessageList(GetMessageListRequest) returns (GetMessageListReply) {
    option (google.api.http) = {
      get : "/api/chat/messageList",
    };
  }

  rpc CreateGroup(CreateGroupRequest) returns (CreateGroupReply) {
    option (google.api.http) = {
      post : "/api/group/create",
      body : "*",
    };
  }

  rpc LoadMyGroup(LoadMyGroupRequest) returns (LoadMyGroupReply) {
    option (google.api.http) = {
      get : "/api/group/loadMyGroup"
    };
  }

  rpc LoadJoinGroup(LoadJoinGroupRequest) returns (LoadJoinGroupReply) {
    option (google.api.http) = {
      get : "/api/group/loadJoinGroup"
    };
  }


  rpc SetAdmin(SetAdminRequest) returns (SetAdminReply) {
    option (google.api.http) = {
      post : "/api/group/setAdmin",
      body : "*",
    };
  }
}

// 前端错误信息查看
// NID_Describe_Message
message Res {
  int32 code = 1;  // 业务状态码，例如 200、422
  string reason = 2;  // 原因
  string msg = 3;  // 详细描述信息
}


message SetAdminRequest {
  uint32 userId = 1;
  uint32 groupId = 2;
}

message SetAdminReply {
  int32 code = 1;
  Res res = 2;
}

message LoadJoinGroupRequest {
  uint32 userId = 1;
}

message LoadJoinGroupReply {
  int32 code = 1;
  Res res = 2;
  repeated MyGroupData data = 3;
}

message LoadMyGroupRequest {
  uint32 userId = 1;
}

message LoadMyGroupReply {
  int32 code = 1;
  Res res = 2;
  repeated MyGroupData data = 3;
}

message MyGroupData {
  uint32 groupId = 1;
  string name = 2;
  string avatar = 3;
}

message CreateGroupRequest {
  uint32 user_id = 1;
  string name = 2;
  uint32 mode = 3;      // 群模式 0-公开群 1-私密群
  uint32 add_mode = 4;  // 加群方式 0-自由加入 1-需要验证
  string intro = 5;     // 群简介
}

message CreateGroupReply {
  int32 code = 1;
  Res res = 2;
  uint32 group_id = 3;
}

// NID_REGIDTER_REQ
message RegisterRequest {
  string username = 1;
  string phone = 2;
  string password = 3;
  string code = 4;
}

message RegisterReply {
  int32 code = 1;
  Res res = 2;
  string token = 3;
}

//NID_LOGIN_REQ
message LoginRequest {
  string phone = 1;
  string password = 2;
}

message LoginBySmsRequest {
  string phone = 1;
  string code = 2;
}

message LoginReply {
  int32 code = 1;  // 0=成功, 1=失败
  Res res = 2;  // 业务信息
  string token = 3;
}

message SendSmsRequest {
  string phone = 1;
  string scene = 2;
}

message SendSmsReply {
  int32 code = 1;
  Res res = 2;
}

//NID_UPDATE_REQ
message UpdateUserPwdRequest {
  string phone = 1;
  string old_password = 2;
  string new_password = 3;
}

message UpdateUserPwdReply {
  int32 code = 1;  // 0=成功, 1=失败
  Res res = 2;  // 业务信息
}

message ResetUserPwdRequest {
  string phone = 1;
  string code = 2;
  string new_password = 3;
}

message ResetUserPwdReply {
  int32 code = 1;
  Res res = 2;
}

message UpdateUserInfoRequest {
  string username    = 1;
  Gender gender      = 2;
  google.protobuf.Timestamp birthday = 3;
  string bio         = 4;
  string head_image  = 5;
  string cover_image = 6;
}

enum Gender {
  UNKNOWN = 0;
  MALE    = 1;
  FEMALE  = 2;
  OTHER   = 3; // 可选
}

message UpdateUserInfoReply {
  int32 code = 1;
  Res res = 2;
}

// Social 相关协议
// NID_GET_PROFILE_REQ
message ProfileData {
  uint32 user_id = 2;
  string tags = 3;
  uint32 follow_count = 4;
  uint32 fan_count = 5;

  uint32 view_count = 6;
  uint32 note_count = 7;
  uint32 received_like_count = 8;
  uint32 collected_count = 9;
  uint32 comment_count = 10;

  string last_login_ip = 11;
  google.protobuf.Timestamp last_active = 12;
  string status = 13;
}

// NID_GET_PROFILE_REQ
message GetProfileRequest { string user_id = 1; }

message GetProfileReply {
  int32 code = 1;
  Res res = 2;
  ProfileData data = 3;
}

// NID_FOLLOW_FAN_REQ
message FollowUserRequest { string target_id = 1; }

message UnfollowUserRequest { string target_id = 1; }

message FollowFanReply {
  int32 code = 1;
  Res res = 2;
  FollowFanData data = 3;
}

message FollowFanData {
  // 当前用户信息
  uint32 self_id = 1;
  uint32 follow_count = 2; // 我的关注数
  // 对方用户信息
  uint32 target_id = 3;
  uint32 fan_count = 4;    // 对方的粉丝数
}

message RelationshipRequest { string target_id = 1; }

message RelationshipReply {
  int32 code = 1;
  Res res = 2;
  RelationshipData data = 3;
}

message RelationshipData {
  bool is_following = 1;    // 当前用户是否已关注对方
  bool is_followed_by = 2;  // 当前用户是否被对方关注
  bool is_mutual = 3;       // 是否互相关注
  bool is_blocked = 4;      // 当前用户是否已拉黑对方
  bool is_blocked_by = 5;   // 当前用户是否被对方拉黑
  bool is_friend = 6;       // 是否是好友（如果互关=好友，可以合并，目前互关和好友不是等价的）
}

// NID_FRIENDS_REQ
message CanAddFriendReq { string target_id = 1; }

message CanAddFriendRes {
  int32 code = 1;
  Res res = 2;
  AddFriendRes data = 3;
}

message AddFriendRes {}

// 全量请求的回包数据
message Message {
  string sendId = 1;         // 发送者ID
  string sendName = 2;       // 发送者昵称
  string sendAvatar = 3;     // 发送者头像
  string receiveId = 4;      // 接收者ID
  string receiveAvatar = 5;  // 接收者头像
  string type = 6;            // 消息类型（字符串格式）
  string content = 7;         // 消息内容
  string url = 8;             // 文件或图片地址
  string fileSize = 9;       // 文件大小
  string fileName = 10;      // 文件名
  string fileType = 11;     // 文件类型
  string avdata = 13;     // 音视频数据
  int32 status = 14;         // 消息状态，0.发送中 1.已送达 2.已读
}

message GetMessagesRequest {
  int32 messageType = 1;  // 消息类型，1.单聊 2.群聊
  string uuid = 2;        // 当前用户uuid
  string friendUuid = 3;  // 好友用户uuid(单聊) 或 群聊uuid(群聊)
  int32 page = 4;         // 分页页码
  int32 pageSize = 5;     // 分页每页数量
}

message GetMessagesReply {
  int32 code = 1;
  Res res = 2;
  repeated Message data = 3;  // 消息列表
  int32 total = 4;           // 总消息数
  int32 page = 5;            // 当前页码
  int32 pageSize = 6;        // 每页数量
}

// NID_GET_MESSAGE_LIST_REQ
message GetMessageListRequest {
  string uuid1 = 1;
  string uuid2 = 2;
}

// NID_GET_MESSAGE_LIST_RES
message GetMessageListReply {
  int32 code = 1;
  Res res = 2;
  repeated Message data = 3;
}







